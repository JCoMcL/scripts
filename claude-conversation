#!/bin/bash
# Select and export a Claude Code conversation from history
#
# Usage: ./select-conversation.sh [output.md]
#
# Dependencies: jq, umenu (or fzf as fallback)

set -eo pipefail

HISTORY_FILE="${CLAUDE_HISTORY:-$HOME/.claude/history.jsonl}"
CONV_DIR="${CLAUDE_CONV_DIR:-$HOME/.claude}"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Check if history file exists
if [[ ! -f "$HISTORY_FILE" ]]; then
    echo "Error: History file not found at $HISTORY_FILE" >&2
    exit 1
fi

# Detect which menu program to use
if command -v umenu &> /dev/null; then
    MENU="umenu"
elif command -v fzf &> /dev/null; then
    MENU="fzf"
else
    echo "Error: Neither umenu nor fzf found. Please install one." >&2
    exit 1
fi

# Format history entries for display and selection
# Output format: "timestamp | first 80 chars of prompt | sessionId"
SELECTION=$(cat "$HISTORY_FILE" | jq -r '
    # Convert timestamp to readable format
    (.timestamp / 1000 | strftime("%Y-%m-%d %H:%M:%S")) as $time |
    # Truncate display text to 80 chars
    (.display | gsub("\n"; " ") | .[0:80]) as $text |
    # Output formatted line with sessionId at the end
    "\($time) | \($text) | \(.sessionId)"
' | tail -36 | $MENU | sed 's/.* | //')

# Check if user selected something
if [[ -z "$SELECTION" ]]; then
    echo "No selection made" >&2
    exit 1
fi

if ! [[ "$1" = "--file" ]]
	then echo $SELECTION && exit 0
fi

# Find the conversation file
CONV_FILE=$(find "$CONV_DIR" -name "$SELECTION.jsonl")

if [[ ! -f "$CONV_FILE" ]]; then
    echo "Error: Conversation file not found: $CONV_FILE" >&2
    exit 1
fi

echo $CONV_FILE

